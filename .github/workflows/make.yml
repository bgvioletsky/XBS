name: make_xbs

on:
  workflow_dispatch:

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22.5'

    - name: Build
      run: |
          make
          echo "下面是用于解密的">> kk.txt
          if [ ! -f  version.txt ]; then
               echo "0.0.0" > version.txt
           fi
           VERSION=$(cat version.txt)
           IFS='.' read -r -a versionArray <<< "$VERSION"
           ((versionArray[2]++))
           
           # 如果最后一位数字达到了20,则将它设为0并递增前一位数字
           if [ "${versionArray[2]}" -eq 20 ]; then
               versionArray[2]=0
               ((versionArray[1]++))
           
               # 如果第二位数字达到了20,则将它设为0并递增第一位数字
               if [ "${versionArray[1]}" -eq 20 ]; then
                   versionArray[1]=0
                   ((versionArray[0]++))
               fi
           fi
           
           # 将新版本号写回到version.txt文件中
           echo "${versionArray[0]}.${versionArray[1]}.${versionArray[2]}" > version.txt
           vss=$(cat version.txt)
           # 打印新版本号
           echo "version=mac_v${vss}" >> $GITHUB_ENV
    - name: commit
      run: |
          git config --local user.email "44770157@qq.com"
          git config --local user.name "bgcode"
          git pull
          git add version.txt
          git commit -m "update $(date +'%Y-%m-%d %H:%M:%S')"  
    - name:  Push changes
      uses:    ad-m/github-push-action@master
      with:  
       branch: main
    - name: 发布到release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{env.version}}
        body_path: ./kk.txt
        files: ./kk/*